<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE stax SYSTEM "../../../stax.dtd">
<!--
 ! CDDL HEADER START
 !
 ! The contents of this file are subject to the terms of the
 ! Common Development and Distribution License, Version 1.0 only
 ! (the "License").  You may not use this file except in compliance
 ! with the License.
 !
 ! You can obtain a copy of the license at
 ! trunk/opends/resource/legal-notices/OpenDS.LICENSE
 ! or https://OpenDS.dev.java.net/OpenDS.LICENSE.
 ! See the License for the specific language governing permissions
 ! and limitations under the License.
 !
 ! When distributing Covered Code, include this CDDL HEADER in each
 ! file and include the License file at
 ! trunk/opends/resource/legal-notices/OpenDS.LICENSE.  If applicable,
 ! add the following below this CDDL HEADER, with the fields enclosed
 ! by brackets "[]" replaced with your own identifying information:
 !      Portions Copyright [yyyy] [name of copyright owner]
 !
 ! CDDL HEADER END
 !
 !      Portions Copyright 2006-2007 Sun Microsystems, Inc.
 ! -->
<stax>
  
<defaultcall function="subject_attribute_mapper"/>
<function name="subject_attribute_mapper" scope="local">      

<sequence>
                               
       <!--- Test Case : setup -->
       <!---
	#@TestMarker              Setup Tests
	#@TestName                Set the SASL EXTERNAL mechanism to Subject attribute  to User Attribute
	#@TestIssue                   
	#@TestPurpose            Set the SASL EXTERNAL mechanism to Subject attribute to User Attribute
	#@TestPreamble           none
	#@TestStep                  Map attributes from the certificate subject to attributes in user entries
	#@TestPostamble          none
	#@TestResult                Success if OpenDS returns 0 for all operations
      -->
		  
    
  <testcase name="'Security: client_auth:  setup - subject_attribute_mapper'">

	  <sequence>
      <call function="'testCase_Preamble'"/>

      <message>
             '----  Configure the SASL EXTERNAL mechanism with Subject Attribute to User Attribute mapper -----'
      </message>			
		
      <call function="'modifyAnAttribute'">
          { 'dsInstanceHost'       :  DIRECTORY_INSTANCE_HOST ,
             'dsInstancePort'       : DIRECTORY_INSTANCE_PORT ,
             'dsInstanceDn'	        : DIRECTORY_INSTANCE_DN ,
             'dsInstancePswd'      : DIRECTORY_INSTANCE_PSWD ,
             'DNToModify'	        :  'cn=EXTERNAL,cn=SASL Mechanisms,cn=config',
             'attributeName'        : 'ds-cfg-certificate-mapper-dn',
             'newAttributeValue'  : 'cn=Subject Attribute to User Attribute,cn=Certificate Mappers,cn=config',
             'changetype' : 'replace' }
      </call>
   
		            
     <message>
             '----  Configure the Subject Attribute to User Attribute mapper -----'
      </message>	
     <script>
             listAttr = []  
             listAttr.append('cn=ds-cfg-certificate-subject-attribute-mapping:cn:cn')
             listAttr.append('cn=ds-cfg-certificate-subject-attribute-mapping:e:mail')		 
      </script>  		  		 

      <call function="'testCase_Postamble'"/>
    </sequence>
  </testcase>
  
  
<!---
	#@TestMarker             Subject Attributes mapping to user attribute 
	#@TestName               Use only one attribute mapping
	#@TestIssue                   
	#@TestPurpose            Map attributes from the certificate subject to attributes in user entries
    #@TestStep                  the subject certificate is defined with the format : uid=client-cert-1,SUFFIX
	#@TestStep                  The mapping will be done on the attribute uid from the cerficate subject      
    #@TestStep                  and the attribute 'description' of the user's entry
	#@TestPreamble          none
	#@TestPostamble         none
	#@TestResult               Success if OpenDS returns 0 for all operations
      -->
    
  <testcase name="'Security: client_auth: subject attribute mapping'">
    <sequence>
   <script>

    USER_1_CERT="client-cert-1"
    USER_1_DN="uid=%s,%s" % (USER_1_CERT,DIRECTORY_INSTANCE_SFX)              
 
    USER_2_CERT="client-cert-2"
    USER_2_DN="uid=%s,%s" % (USER_2_CERT,DIRECTORY_INSTANCE_SFX)			       
    STOREPASS="password"
    CERT_TMP="%s/CERT_%s" % (DIRECTORY_INSTANCE_DIR,DIRECTORY_INSTANCE_PORT)
    CLIENT_KEYSTORE="%s/keystore" % (CERT_TMP)                      		
    </script>
    <call function="'testCase_Preamble'"/>
 
    <message>
             '----  Configure the Subject Attribute to User Attribute mapper -----'
      </message>			 
      <message>'---- Add a new mapping rule from attribute "uid"  from certificate subject and attribute "description" of the user entry'</message>	
      <call function="'modifyAnAttribute'">
          { 'dsInstanceHost'       :  DIRECTORY_INSTANCE_HOST ,
             'dsInstancePort'       : DIRECTORY_INSTANCE_PORT ,
             'dsInstanceDn'	        : DIRECTORY_INSTANCE_DN ,
             'dsInstancePswd'      : DIRECTORY_INSTANCE_PSWD ,
             'DNToModify'	        :  'cn=Subject Attribute to User Attribute,cn=Certificate Mappers,cn=config',
             'attributeName'        : 'ds-cfg-certificate-subject-attribute-mapping',
             'newAttributeValue'  : 'uid:description',
             'changetype' : 'replace' }
      </call>
		   
				  
    <message>'----- Configure the attribute description  for user %s ---' % USER_1_DN</message>
    <message>'----- the attribute description will map with the attribute "uid" of the certificate subject'</message>
     
     <call function="'modifyAnAttribute'">
    { 'dsInstanceHost'     : DIRECTORY_INSTANCE_HOST ,
    'dsInstancePort'        : DIRECTORY_INSTANCE_PORT ,
    'dsInstanceDn'	        : DIRECTORY_INSTANCE_DN ,
    'dsInstancePswd'       : DIRECTORY_INSTANCE_PSWD ,
    'DNToModify'	        : USER_1_DN,
    'attributeName'         : 'description',
    'newAttributeValue'    : USER_1_CERT,
    'changetype'              : 'add' }
    </call>      

	
     <message>'----- Configure the attribute description  for user %s ---' % USER_2_DN</message>
     <message>'----- the attribute description contains invalid value'</message>
	 <message>'----- it will not map with the attribute "uid" of the certificate subject'</message>
 
 
     <call function="'modifyAnAttribute'">
    { 'dsInstanceHost'   : DIRECTORY_INSTANCE_HOST ,
    'dsInstancePort'       : DIRECTORY_INSTANCE_PORT ,
    'dsInstanceDn'	       : DIRECTORY_INSTANCE_DN ,
    'dsInstancePswd'     : DIRECTORY_INSTANCE_PSWD ,
    'DNToModify'	      : USER_2_DN,
    'attributeName'       : 'description',
    'newAttributeValue'  : 'bad-certificate',
    'changetype'            : 'add' }
    </call>               
        
		
    <!--  Check mapping is working -->         
 
   <message>'--- Check SSL communication with SASL EXTERNAL authentication'</message>		
		
   <!-- bound as USER_1_DN -->				
     <call function="'ldapSearchWithScript'">
		{ 'dsInstanceHost'   : DIRECTORY_INSTANCE_HOST ,
		  'dsInstancePort'   : DIRECTORY_INSTANCE_SSL_PORT ,		 
          'dsBaseDN'         : DIRECTORY_INSTANCE_SFX,		 
		  'dsFilter'		: 'objectclass=*'	,
          'dsKeyStorePassword'   :  STOREPASS,
          'dsUseSSL'             :  ' ',
          'dsUseSASLExternal'   :  ' ',
          'dsCertNickname'       : USER_1_CERT,
          'dsTrustStorePath'       : CLIENT_KEYSTORE,
          'dsKeyStorePath'        : CLIENT_KEYSTORE,
          'dsReportAuthzID'   : ' ',
          'dsScope'                 : 'base' }
     </call>    
		
     <script>
           STAXCode = RC
           ldapSearchResult = STAXResult[0][1]
     </script>
     <call function="'CheckMatches'">
             { 'string2find' : USER_1_DN ,
                'mainString'    : ldapSearchResult ,
                'nbExpected'    : 1
             }
    </call>			           

   <!-- No mapping expected -->		
     <call function="'ldapSearchWithScript'">
		{ 'dsInstanceHost'   : DIRECTORY_INSTANCE_HOST ,
		  'dsInstancePort'   : DIRECTORY_INSTANCE_SSL_PORT ,		 
          'dsBaseDN'         : DIRECTORY_INSTANCE_SFX,		 
		  'dsFilter'		: 'objectclass=*'	,
          'dsKeyStorePassword'   :  STOREPASS,
          'dsUseSSL'             :  ' ',
          'dsUseSASLExternal'   :  ' ',
          'dsCertNickname'       : USER_2_CERT,
          'dsTrustStorePath'       : CLIENT_KEYSTORE,
          'dsKeyStorePath'        : CLIENT_KEYSTORE,
          'dsReportAuthzID'   : ' ',
          'dsScope'                 : 'base',
		  'expected'               : 49 }
     </call>    
		
		

   <message>'--- Check StartTLS communication with SASL EXTERNAL authentication'</message>		
		
   <!-- bound as USER_1_DN -->				
     <call function="'ldapSearchWithScript'">
		{ 'dsInstanceHost'   : DIRECTORY_INSTANCE_HOST ,
		  'dsInstancePort'   : DIRECTORY_INSTANCE_PORT ,		 
          'dsBaseDN'         : DIRECTORY_INSTANCE_SFX,		 
		  'dsFilter'		: 'objectclass=*'	,
          'dsKeyStorePassword'   :  STOREPASS,
          'dsUseStartTLS'             :  ' ',
          'dsUseSASLExternal'   :  ' ',
          'dsCertNickname'       : USER_1_CERT,
          'dsTrustStorePath'       : CLIENT_KEYSTORE,
          'dsKeyStorePath'        : CLIENT_KEYSTORE,
          'dsReportAuthzID'   : ' ',
          'dsScope'                 : 'base' }
     </call>    
		
     <script>
           STAXCode = RC
           ldapSearchResult = STAXResult[0][1]
     </script>
     <call function="'CheckMatches'">
             { 'string2find' : USER_1_DN ,
                'mainString'    : ldapSearchResult ,
                'nbExpected'    : 1
             }
    </call>			           

   <!-- No mapping expected -->		
     <call function="'ldapSearchWithScript'">
		{ 'dsInstanceHost'   : DIRECTORY_INSTANCE_HOST ,
		  'dsInstancePort'   : DIRECTORY_INSTANCE_PORT ,		 
          'dsBaseDN'         : DIRECTORY_INSTANCE_SFX,		 
		  'dsFilter'		: 'objectclass=*'	,
          'dsKeyStorePassword'   :  STOREPASS,
          'dsUseStartTLS'             :  ' ',
          'dsUseSASLExternal'   :  ' ',
          'dsCertNickname'       : USER_2_CERT,
          'dsTrustStorePath'       : CLIENT_KEYSTORE,
          'dsKeyStorePath'        : CLIENT_KEYSTORE,
          'dsReportAuthzID'   : ' ',
          'dsScope'                 : 'base',
		  'expected'               : 49 }
     </call>    
		

							
    <call function="'testCase_Postamble'"/>      
    </sequence>
  </testcase>

</sequence>
</function>

</stax>
